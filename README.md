# PR Review Manager

Сервис для автоматического назначения ревьюеров на Pull Request'ы.

## Стек

- Go 1.23
- PostgreSQL 15
- Chi router
- Docker & Docker Compose

## Запуск

```bash
docker-compose up --build
```

Сервис станет доступен на порту 8080.


## API

### Команды

**Создать команду**
```bash
curl -X POST http://localhost:8080/team/add \
  -H "Content-Type: application/json" \
  -d '{
    "team_name": "backend",
    "members": [
      {"user_id": "u1", "username": "Alice", "is_active": true},
      {"user_id": "u2", "username": "Bob", "is_active": true}
    ]
  }'
```

**Получить команду**
```bash
curl "http://localhost:8080/team/get?team_name=backend"
```

**Массовая деактивация команды**
```bash
curl -X POST http://localhost:8080/team/deactivate \
  -H "Content-Type: application/json" \
  -d '{"team_name": "backend"}'
```

Возвращает:
```json
{
  "deactivated_users_count": 5,
  "affected_prs_count": 12
}
```

### Пользователи

**Изменить активность**
```bash
curl -X POST http://localhost:8080/users/setIsActive \
  -H "Content-Type: application/json" \
  -d '{"user_id": "u2", "is_active": false}'
```

**Получить PR на ревью**
```bash
curl "http://localhost:8080/users/getReview?user_id=u1"
```

### Pull Requests

**Создать PR**
```bash
curl -X POST http://localhost:8080/pullRequest/create \
  -H "Content-Type: application/json" \
  -d '{
    "pull_request_id": "pr-1001",
    "pull_request_name": "Add search feature",
    "author_id": "u1"
  }'
```

**Смержить PR**
```bash
curl -X POST http://localhost:8080/pullRequest/merge \
  -H "Content-Type: application/json" \
  -d '{"pull_request_id": "pr-1001"}'
```

**Переназначить ревьювера**
```bash
curl -X POST http://localhost:8080/pullRequest/reassign \
  -H "Content-Type: application/json" \
  -d '{
    "pull_request_id": "pr-1001",
    "old_user_id": "u2"
  }'
```


## Структура

```
cmd/server/          # Запуск приложения
internal/
  domain/            # Модели данных
  repository/        # Работа с БД
  service/           # Бизнес-логика
  handler/           # HTTP handlers
  router/            # Роутинг
  errors/            # Ошибки
pkg/database/        # Подключение к БД
migrations/          # SQL миграции
```


## Как работает

**Создание PR:**
- При создании автоматически назначаются до 2 активных участников из команды автора
- Автор не может быть ревьювером своего PR
- Если активных участников меньше 2, назначается сколько есть

**Переназначение:**
- Можно заменить только уже назначенного ревьювера
- Новый ревьювер выбирается случайным образом из активных участников команды того, кого заменяем
- После merge переназначение невозможно

**Merge:**
- Операция идемпотентна - повторный вызов не вызовет ошибку
- После merge нельзя менять ревьюверов

**Массовая деактивация команды:**
- Деактивирует всех пользователей команды одновременно
- Автоматически переназначает открытые PR на активных пользователей из других команд
- Все операции выполняются в одной транзакции

**Производительность:**
- 3 пользователя + 5 PR: 76ms
- 3 пользователя + 10 PR: 90ms
- 5 пользователей + 40 PR: 94ms
- 6 пользователей + 60 PR: 180ms

Результат достигнут за счёт batch-операций: вместо отдельного SQL-запроса на каждый PR делаем один большой запрос для всех сразу. Например, вместо 60 INSERT'ов выполняется один с 60 строками. То же самое с удалением ревьюверов и получением данных о PR.


## Ошибки

- `TEAM_EXISTS` - команда уже существует
- `PR_EXISTS` - PR уже существует
- `PR_MERGED` - нельзя изменять смерженный PR
- `NOT_ASSIGNED` - пользователь не назначен ревьювером
- `NO_CANDIDATE` - нет доступных кандидатов
- `NOT_FOUND` - не найдено


## База данных

**Таблицы:**
- `teams` - команды
- `users` - пользователи
- `pull_requests` - PR'ы
- `pr_reviewers` - связь PR с ревьюверами

**Индексы:**
- По team_name для поиска участников
- По is_active для фильтрации активных
- По author_id и status для поиска PR
- По user_id для поиска назначений


## Принятые решения

### Выбор ревьюверов
Используется случайный выбор через `rand.Shuffle()` для равномерного распределения нагрузки между участниками.

### Переназначение из команды заменяемого
Новый ревьювер выбирается именно из команды того ревьювера, которого заменяем (а не из команды автора). Это следует из формулировки задания "случайного активного участника из команды заменяемого ревьювера".

### Идемпотентность merge
Повторный вызов merge просто возвращает текущее состояние PR без ошибки. Так проще работать с API и безопаснее при сетевых проблемах.

### Транзакции
Создание команды с участниками и создание PR с ревьюверами выполняются в транзакциях, чтобы не было частичного сохранения данных.

### Миграции
Применяются при старте приложения.

### Строковые ID
Используются VARCHAR вместо числовых ID для гибкости при интеграции с GitHub/GitLab и другими системами.

### Оптимизация массовой деактивации
Для достижения производительности <100ms на средних объемах применены следующие методы:

1. **Batch-операции**: Вместо N отдельных SQL-запросов используются массовые операции
   - `RemoveDeactivatedReviewersFromAllPRs` - удаляет всех деактивированных ревьюверов одним запросом
   - `GetPRsWithReviewers` - получает информацию о всех затронутых PR одним JOIN-запросом
   - `BatchAddReviewers` - добавляет новых ревьюверов массовой вставкой

2. **Минимизация запросов к БД**: 
   - Активные пользователи загружаются один раз для всех PR
   - Информация о PR с ревьюверами получается одним запросом

3. **Транзакционность**: Все операции в одной транзакции предотвращают частичные изменения и улучшают производительность

4. **Эффективные SQL-запросы**: Использование индексов и оптимальных JOIN для быстрой фильтрации


## Сборка и запуск

**Собрать:**
```bash
make build
```

**Запустить локально (без Docker):**
```bash
docker-compose up postgres

export DB_HOST=localhost
export DB_PORT=5432
export DB_USER=pruser
export DB_PASSWORD=prpass
export DB_NAME=pr_review_db
export DB_SSLMODE=disable

make run
```
