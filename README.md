# PR Review Manager

Микросервис для автоматического назначения ревьюеров на Pull Request'ы с управлением командами и пользователями.

## Описание

Сервис автоматически назначает до двух активных ревьюеров из команды автора PR, позволяет переназначать ревьюверов и управлять командами. После merge PR изменение состава ревьюеров запрещено.

## Технологический стек

- **Язык**: Go 1.23
- **База данных**: PostgreSQL 15
- **HTTP роутер**: Chi v5
- **Миграции**: golang-migrate
- **Контейнеризация**: Docker, Docker Compose

## Быстрый старт

### Запуск через Docker Compose

```bash
docker-compose up --build
```

Сервис будет доступен на `http://localhost:8080`

### Проверка работоспособности

```bash
curl http://localhost:8080/health
```

## API эндпоинты

### Управление командами

#### POST /team/add
Создание команды с участниками.

```bash
curl -X POST http://localhost:8080/team/add \
  -H "Content-Type: application/json" \
  -d '{
    "team_name": "backend",
    "members": [
      {"user_id": "u1", "username": "Alice", "is_active": true},
      {"user_id": "u2", "username": "Bob", "is_active": true}
    ]
  }'
```

#### GET /team/get?team_name=backend
Получение информации о команде.

```bash
curl "http://localhost:8080/team/get?team_name=backend"
```

### Управление пользователями

#### POST /users/setIsActive
Установка флага активности пользователя.

```bash
curl -X POST http://localhost:8080/users/setIsActive \
  -H "Content-Type: application/json" \
  -d '{"user_id": "u2", "is_active": false}'
```

#### GET /users/getReview?user_id=u1
Получение списка PR, где пользователь назначен ревьювером.

```bash
curl "http://localhost:8080/users/getReview?user_id=u1"
```

### Управление Pull Request

#### POST /pullRequest/create
Создание PR с автоматическим назначением ревьюеров.

```bash
curl -X POST http://localhost:8080/pullRequest/create \
  -H "Content-Type: application/json" \
  -d '{
    "pull_request_id": "pr-1001",
    "pull_request_name": "Add search feature",
    "author_id": "u1"
  }'
```

#### POST /pullRequest/merge
Перевод PR в статус MERGED (идемпотентная операция).

```bash
curl -X POST http://localhost:8080/pullRequest/merge \
  -H "Content-Type: application/json" \
  -d '{"pull_request_id": "pr-1001"}'
```

#### POST /pullRequest/reassign
Переназначение ревьювера.

```bash
curl -X POST http://localhost:8080/pullRequest/reassign \
  -H "Content-Type: application/json" \
  -d '{
    "pull_request_id": "pr-1001",
    "old_user_id": "u2"
  }'
```

## Архитектура проекта

```
pr-review-manager/
├── cmd/server/          # Точка входа приложения
├── internal/
│   ├── domain/          # Доменные модели (User, Team, PullRequest)
│   ├── repository/      # Слой работы с БД
│   ├── service/         # Бизнес-логика
│   ├── handler/         # HTTP обработчики
│   ├── router/          # Маршрутизация
│   └── errors/          # Доменные ошибки
├── pkg/database/        # Утилиты для работы с БД
└── migrations/          # SQL миграции
```

## Бизнес-правила

1. **Назначение ревьюверов при создании PR**:
   - Автоматически назначаются до 2 активных участников из команды автора
   - Автор не может быть ревьювером своего PR
   - Если доступных кандидатов меньше 2, назначается доступное количество

2. **Переназначение ревьювера**:
   - Можно заменить только уже назначенного ревьювера
   - Новый ревьювер выбирается случайно из активных участников команды заменяемого
   - Нельзя назначить автора или уже назначенных ревьюверов
   - После MERGED переназначение запрещено

3. **Активность пользователей**:
   - Неактивные пользователи (`is_active = false`) не назначаются на ревью
   - Можно изменять активность в любой момент

4. **Идемпотентность merge**:
   - Повторный вызов merge не вызывает ошибку
   - Возвращает актуальное состояние PR

## Коды ошибок

- `TEAM_EXISTS` (400) - команда уже существует
- `PR_EXISTS` (409) - PR с таким ID уже существует
- `PR_MERGED` (409) - нельзя изменять merged PR
- `NOT_ASSIGNED` (409) - пользователь не назначен ревьювером на этот PR
- `NO_CANDIDATE` (409) - нет доступных кандидатов для назначения
- `NOT_FOUND` (404) - ресурс не найден

## Структура базы данных

### Таблицы

- `teams` - команды разработчиков
- `users` - пользователи с привязкой к командам
- `pull_requests` - информация о PR
- `pr_reviewers` - связь PR с ревьюверами (many-to-many)

### Индексы

Созданы индексы для оптимизации частых запросов:
- `users(team_name)` - поиск участников команды
- `users(is_active)` - фильтрация активных пользователей
- `pull_requests(author_id)` - поиск PR по автору
- `pull_requests(status)` - фильтрация по статусу
- `pr_reviewers(user_id)` - поиск PR по ревьюверу

## Принятые решения и допущения

### 1. Алгоритм выбора ревьюверов

**Решение**: Случайный выбор с использованием `rand.Shuffle()`.

**Обоснование**: Обеспечивает равномерное распределение нагрузки между участниками команды. Для реальных проектов можно расширить алгоритм учётом текущей нагрузки ревьюверов.

### 2. Транзакции

**Решение**: Используются транзакции для атомарных операций (создание команды с участниками, создание PR с ревьюверами).

**Обоснование**: Гарантирует консистентность данных и предотвращает частичное выполнение операций.

### 3. Идемпотентность merge

**Решение**: Повторный вызов merge возвращает актуальное состояние без ошибки.

**Обоснование**: Соответствует требованиям задания и принципам REST API. Позволяет безопасно повторять операцию при сетевых сбоях.

### 4. Миграции

**Решение**: Автоматическое применение миграций при старте приложения.

**Обоснование**: Упрощает развёртывание и соответствует требованию запуска через `docker-compose up`.

### 5. Обработка ошибок

**Решение**: Структурированные доменные ошибки с кодами согласно OpenAPI спецификации.

**Обоснование**: Обеспечивает предсказуемые ответы API и упрощает отладку на клиентской стороне.

### 6. Переназначение из команды заменяемого

**Вопрос**: Из какой команды выбирать нового ревьювера при переназначении?

**Решение**: Новый ревьювер выбирается из команды заменяемого ревьювера.

**Обоснование**: Согласно заданию "случайного активного участника из команды заменяемого ревьювера". Это позволяет заменять ревьюверов внутри той же команды, сохраняя экспертизу.

### 7. Формат идентификаторов

**Решение**: Используются строковые идентификаторы (VARCHAR).

**Обоснование**: Обеспечивает гибкость для интеграции с внешними системами (GitHub, GitLab и т.д.).

## Разработка

### Сборка

```bash
make build
```

### Запуск локально

```bash
# Запустить только PostgreSQL
docker-compose up postgres

# Экспортировать переменные окружения
export DB_HOST=localhost
export DB_PORT=5432
export DB_USER=pruser
export DB_PASSWORD=prpass
export DB_NAME=pr_review_db
export DB_SSLMODE=disable

# Запустить сервис
make run
```

### Остановка

```bash
docker-compose down -v
```

## Производительность

Согласно требованиям:
- **RPS**: 5
- **SLI времени ответа**: 300 мс
- **SLI успешности**: 99.9%
- **Объём данных**: до 20 команд, до 200 пользователей

Текущая архитектура легко справляется с указанными параметрами благодаря:
- Индексам на часто используемых полях
- Connection pool для БД
- Минимальному количеству запросов на операцию

## TODO (опциональные расширения)

- [ ] Эндпоинт статистики назначений
- [ ] Нагрузочное тестирование
- [ ] Массовая деактивация команды с переназначением
- [ ] E2E тесты
- [ ] Конфигурация golangci-lint

## Автор

Тестовое задание для стажёра Backend (осенняя волна 2025)
